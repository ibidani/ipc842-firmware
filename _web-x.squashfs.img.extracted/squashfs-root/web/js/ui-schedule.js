(function(){function j(a){var a=a.match(l),b=null;return b=a?{type:a[1].toInt()&7,startTime:a[2],endTime:a[3]}:{type:0,startTime:"00:00:00",endTime:"23:59:59"}}function m(a,b){var c=j(a),e=j(b);return c.type>e.type?-1:c.type<e.type?1:c.startTime+c.endTime>e.startTime+e.endTime?1:-1}var l=/(\d+) (\d\d:\d\d:\d\d)-(\d\d:\d\d:\d\d)/;this.Schedule=new Class({Implements:[Events,Options],options:{holiday:!1,type:["general","motion","alarm"],displayMode:["general","motion","alarm"],width:527,height:210},
initialize:function(a,b){this.setOptions(b||{});if(this.options.holiday)this.options.height=240;this.setType(this.options.type);this.element=$(a);this.element.addClass("ui-schedule");this._addEvent()},render:function(a){if(a){var b=this;b.element.empty();b.timeSchedules=a;b._fixTimeSchedules();b.timeSchedules.each(function(a,e){a.each(function(a){var c=a.split(" ")[0],a=a.split(" ")[1];c&1&&b.options.displayMode.contains("general")&&b._addElement("general",a,e*30+1);c&2&&b.options.displayMode.contains("motion")&&
b._addElement("motion",a,e*30+11);c&4&&b.options.displayMode.contains("alarm")&&b._addElement("alarm",a,e*30+21)})})}},setType:function(a){var b=0;a.contains("general")&&(b+=1);a.contains("motion")&&(b+=2);a.contains("alarm")&&(b+=4);this.type=b},getTimeSchedules:function(){return this.timeSchedules},setTimeSchedules:function(a){this.timeSchedules=a;this.render(a)},_addEvent:function(){this.element.addEvent("mousedown",this._onMouseDown.bind(this));document.addEvents({mouseup:this._onMouseUp.bind(this),
mousemove:this._onMouseMove.bind(this),contextmenu:this._onContextMenu.bind(this)})},_onMouseDown:function(a){if(!this.mousedown_position){var b=this.element._position||this.element.getPosition(),c=a.page;this.mousedown_position={x:Math.max(c.x-b.x).limit(1,this.options.width+1),y:Math.max(c.y-b.y).limit(1,this.options.height)};this.mousedown_mode=a.target==this.element?"add":"delete";this.mousedown_ele=new Element("div",{"class":"ui-schedule-rect",styles:{background:this.mousedown_mode=="add"?"#444":
"#fff"}});this.element.appendChild(this.mousedown_ele);this.element._position=b;this._preventSelect()}},_onMouseUp:function(a){if(this.mousedown_position){var b=this.element._position,a=a.page,b={x:(a.x-b.x).limit(1,this.options.width+1),y:(a.y-b.y).limit(1,this.options.height)},a=this.mousedown_position,b={left:Math.min(b.x,a.x),top:Math.min(b.y,a.y),width:Math.abs(b.x-a.x),height:Math.abs(b.y-a.y)};this.mousedown_position=null;this.element.removeChild(this.mousedown_ele);this._afterDraw(b);this._releaseSelect()}},
_onMouseMove:function(a){if(this.mousedown_position){var b=this.element._position,c=a.page,b={x:(c.x-b.x).limit(1,this.options.width+1),y:(c.y-b.y).limit(1,this.options.height)},c=this.mousedown_position,b={left:Math.min(b.x,c.x),top:Math.min(b.y,c.y),width:Math.abs(b.x-c.x),height:Math.abs(b.y-c.y)};this.mousedown_ele&&this.mousedown_ele.setStyles(b);a.stop()}},_onContextMenu:function(a){a=a.target&&a.target.className;if(typeOf(a)=="string"&&a.contains("ui-schedule"))return!1},_afterDraw:function(a){this.mousedown_mode==
"add"?a.width&&this._addTimeSection(a):this._removeTimeSection(a)},_addTimeSection:function(a){var b=this,c=this._rectToTimeObj(a);b.timeSchedules.each(function(e,g){if(a.top<30*(g+1)&&a.top+a.height>30*g){for(var h=0,f=e.length;h<f;h++){var d=j(e[h]);if((d.type&7)==b.type&&d.endTime>c.startTime&&d.startTime<c.endTime){e[h]=d.type+" "+(c.startTime<d.startTime?c.startTime:d.startTime)+"-"+(c.endTime>d.endTime?c.endTime:d.endTime);return}else if(d.type&&(b.type&d.type)==d.type&&d.startTime>=c.startTime&&
d.endTime<=c.endTime){e[h]=b.type+" "+c.startTime+"-"+c.endTime;return}}h=0;for(f=e.length;h<f;h++)if(d=e[h].split(" ")[0].toInt(),!(d&7)){e[h]=(d|b.type)+" "+c.startTime+"-"+c.endTime;break}}});this.render(this.timeSchedules);this.fireEvent("change",Object.clone(this.timeSchedules))},_removeTimeSection:function(a){var b=this,c=this._rectToTimeObj(a);b.timeSchedules.each(function(e,g){a.top<30*(g+1)&&a.top+a.height>30*g&&e.each(function(a,f){var d=j(a);d.endTime>c.startTime&&d.startTime<c.endTime&&
(d=j(e[f]),b.type&1&&(d.type&=65534),b.type&2&&(d.type&=65533),b.type&4&&(d.type&=65531),e[f]=d.type&7?d.type+" "+d.startTime+"-"+d.endTime:"0 00:00:00-23:59:59")})});this.render(this.timeSchedules);this.fireEvent("change",Object.clone(this.timeSchedules))},_addElement:function(a,b,c){b=this._timeToRect(b);this.element.appendChild(new Element("div",{"class":"ui-schedule-"+a,styles:{left:b.left,width:b.width,top:c}}))},_timeToRect:function(a){var b=a.split("-")[0],a=a.split("-")[1],b=this._timeToPoint(b),
a=this._timeToPoint(a)-b;return{left:b,width:a}},_rectToTimeObj:function(a){return{startTime:this._pointToTime(a.left),endTime:this._pointToTime(a.left+a.width)}},_timeToPoint:function(a){a=a.split(":").map(function(a){return a.toInt()});return(a[0]*3600+a[1]*60+a[2])/86399*this.options.width+1},_pointToTime:function(a){var b=(a-1)/this.options.width*86399,a=(b/3600).toInt(),c=((b-a*3600)/60).toInt(),b=(b%60).toInt();return(a<10?"0"+a:a)+":"+(c<10?"0"+c:c)+":"+(b<10?"0"+b:b)},_fixTimeSchedules:function(){var a=
this;a.timeSchedules.each(function(b,c){var e=a.timeSchedules,g;g=Array.clone(b);for(var h=g.length-1;h>0;h--)for(var f=j(g[h]),d=0;d<h;d++)if(f.type!=0){var i=j(g[d]),k=f.type&i.type;f.type==i.type&&f.startTime<i.endTime&&f.endTime>i.startTime?(g[d]=i.type+" "+(f.startTime<i.startTime?f.startTime:i.startTime)+"-"+(f.endTime>i.endTime?f.endTime:i.endTime),g[h]="0 00:00:00-23:59:59"):k==f.type&&i.startTime<=f.startTime&&i.endTime>=f.endTime?g[h]="0 00:00:00-23:59:59":k==i.type&&i.startTime>=f.startTime&&
i.endTime<=f.endTime&&(g[d]=g[h],g[h]="0 00:00:00-23:59:59")}g=g.sort(m);e[c]=g})},_preventSelect:function(){if(document.selection&&document.selection.empty)try{document.selection.empty()}catch(a){}window.getSelection&&window.getSelection().removeAllRanges();Browser.ie&&Browser.version>8||($(document.body).setAttribute("onselectstart","javascript:return false;"),$(document.body).setAttribute("unselectable","on"));$(document.body).addClass("fn-unselectable")},_releaseSelect:function(){$(document.body).removeAttribute("onselectstart");
$(document.body).removeAttribute("unselectable");$(document.body).removeClass("fn-unselectable")}})})();
